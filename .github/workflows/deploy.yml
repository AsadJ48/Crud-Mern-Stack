name: Deploy MERN App to Azure VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
        run: |
          set -e
          mkdir -p ~/.ssh
          # write the private key exactly as provided in the secret
          printf "%s" "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Guard: ensure SSH_HOST is set
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "‚ùå SSH_HOST secret is empty. Set it in Settings ‚Üí Secrets ‚Üí Actions."
            exit 1
          fi

      # === DEBUG (temporary; safe to keep until things are green) ===
      - name: Show host & user (diagnostic)
        run: |
          echo "HOST='${{ secrets.SSH_HOST }}'"
          echo "USER='${{ secrets.SSH_USERNAME }}'"
          echo "KEY first line:"
          head -n 1 ~/.ssh/id_rsa || true
          echo "KEY last line:"
          tail -n 1 ~/.ssh/id_rsa || true

      - name: Test SSH connectivity (verbose)
        run: |
          ssh -vvv -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "echo '‚úÖ SSH OK on runner'"

      # === REAL DEPLOY ===
      - name: Deploy to Azure VM
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
              set -e

              REPO_DIR="$HOME/Crud-Mern-Stack"
              REPO_URL="https://github.com/AsadJ48/Crud-Mern-Stack.git"

              # 1) Ensure repo exists (first run)
              if [ ! -d "$REPO_DIR/.git" ]; then
                echo "üì• Cloning repository..."
                git clone "$REPO_URL" "$REPO_DIR"
              fi

              cd "$REPO_DIR"

              # 2) Ensure correct origin remote
              echo "üîß Ensuring correct remote..."
              git remote set-url origin "$REPO_URL"

              # 3) Force-sync to origin/main and remove untracked files
              echo "üîÑ Force syncing working tree..."
              git fetch origin
              git reset --hard origin/main
              git clean -fd

              # 4) Backend: install deps & (re)start
              echo "üì¶ Backend: installing dependencies..."
              cd backend
              npm install

              # Detect backend entry file
              ENTRY="index.js"
              if [ ! -f "$ENTRY" ]; then
                if [ -f "server.js" ]; then ENTRY="server.js"; else echo "‚ùå No entry file (index.js/server.js) found"; exit 1; fi
              fi

              echo "üöÄ Backend: restarting without PM2..."
              pkill node || true
              nohup node "$ENTRY" > server.log 2>&1 &

              # 5) Frontend: build
              echo "üåê Frontend: building..."
              cd ../frontend
              npm install
              npm run build

              echo "‚úÖ Deployment complete."
          EOF
