- name: Set up SSH key
  run: |
    mkdir -p ~/.ssh
    echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

# === DEBUG STEPS (add these two) ===
- name: Debug key header and user/host
  run: |
    echo "SSH_USERNAME=${{ secrets.SSH_USERNAME }}"
    echo "SSH_HOST=${{ secrets.SSH_HOST }}"
    echo "Key begins with:"
    head -n 1 ~/.ssh/id_rsa
    echo "Key ends with:"
    tail -n 1 ~/.ssh/id_rsa

- name: Test SSH connectivity (verbose)
  run: |
    ssh -vvv -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
      ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "echo '‚úÖ SSH OK on runner'"

# === YOUR EXISTING DEPLOY STEP ===
- name: Deploy to Azure VM
  run: |
    ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
      ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
        cd ~/Crud-Mern-Stack

        echo "üîÑ Pulling latest code..."
        git pull origin main

        echo "üì¶ Installing backend dependencies..."
        cd backend
        npm install

        echo "üöÄ Restarting backend without PM2..."
        pkill node || true
        nohup node index.js > server.log 2>&1 &

        echo "üåê Building frontend..."
        cd ../frontend
        npm install
        npm run build

        echo "‚úÖ Deployment complete."
      EOF
