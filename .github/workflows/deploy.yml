name: Deploy MERN App to Azure VM

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key
  run: |
    set -e
    mkdir -p ~/.ssh
    echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa

    # Guard: ensure SSH_HOST is set
    if [ -z "${{ secrets.SSH_HOST }}" ]; then
      echo "‚ùå SSH_HOST secret is empty. Set it in Settings ‚Üí Secrets ‚Üí Actions."
      exit 1
    fi

    # Make ssh-keyscan non-fatal (useful but optional since we also disable host checking)
    ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true


      # === DEBUG (temporary) ===
      - name: Debug key header and user/host
        run: |
          echo "SSH_USERNAME=${{ secrets.SSH_USERNAME }}"
          echo "SSH_HOST=${{ secrets.SSH_HOST }}"
          echo "Key begins with:"
          head -n 1 ~/.ssh/id_rsa
          echo "Key ends with:"
          tail -n 1 ~/.ssh/id_rsa

      - name: Test SSH connectivity (verbose)
        run: |
          ssh -vvv -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "echo '‚úÖ SSH OK on runner'"

      # === REAL DEPLOY ===
      - name: Deploy to Azure VM
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa \
            ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} << 'EOF'
              set -e
              cd ~/Crud-Mern-Stack

              echo "üîÑ Pulling latest code..."
              git pull origin main

              echo "üì¶ Installing backend dependencies..."
              cd backend
              npm install

              echo "üöÄ Restarting backend without PM2..."
              pkill node || true
              nohup node index.js > server.log 2>&1 &

              echo "üåê Building frontend..."
              cd ../frontend
              npm install
              npm run build

              echo "‚úÖ Deployment complete."
          EOF
